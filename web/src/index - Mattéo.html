<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js" integrity="sha512-d9xgZrVZpmmQlfonhQUvTR7lMPtO7NkZMkA0ABN3PHCbKA5nqylQ/yWlFAyY6hYgdF1Qh6nYiuADWwKB4C2WSw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.2.6/mqtt.min.js" integrity="sha512-DD/bXhp28PWFubyhBKR7vt5FUMRCbEJ8KtC4Oq/MTWniMUytsPM5pFDaUTaHDRd7zC8cHpKvv6FaUI2OP/czlw==" crossorigin="anonymous"></script>
</head>
<body>
    <button onclick="addValue()">test</button>
    <button onclick="publish()">publish</button>
    <canvas id="mainGraph">
    </canvas>
    <script>

        var ctx = document.getElementById('mainGraph').getContext('2d');
        var chart = new Chart(ctx, {
            // The type of chart we want to create
            type: 'line',

            // The data for our dataset
            data: {
                labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
                datasets: [{
                    label: 'My First dataset',
                    borderColor: 'rgb(0, 99, 132)',
                    backgroundColor: 'rgba(0, 0, 0, 0)',
                    data: [0, 10, 5, 2, 20, 30, 45, 34]
                }]
            },

            // Configuration options go here
            options: {}
        });

        function addValue(value){
            chart.data.labels.push('Februaryy');
            chart.data.datasets[0].data.push(value);
            chart.update();
        }
        const options = {
          clean: true, // retain session
      connectTimeout: 4000, // Timeout period
      // Authentication information
      clientId: 'emqx_test',
      username: 'emqx_test',
      password: 'emqx_test',
  }

        // Connect string, and specify the connection method by the protocol
        // ws Unencrypted WebSocket connection
        // wss Encrypted WebSocket connection
        // mqtt Unencrypted TCP connection
        // mqtts Encrypted TCP connection
        // wxs WeChat applet connection
        // alis Alipay applet connection
        const connectUrl = 'wss://broker.emqx.io:8084/mqtt'
        const client = mqtt.connect(connectUrl, options)
       function wait(ms){
           var start = new Date().getTime();
           var end = start;
           while(end < start + ms) {
             end = new Date().getTime();
          }
        }
        
        client.on('reconnect', (error) => {
            console.log('reconnecting:', error)
        })

        client.on('error', (error) => {
            console.log('Connection failed:', error)
        })
                client.on('connect', function () {
          client.subscribe('presence', function (err) {
            if (!err) {
              
            }
          })
        })

        function publish(){

            var number = Math.floor((Math.random() * 100) + 1);

             client.publish('presence', number.toString())
             //console.log(number);
        }
        client.on('message', function (topic, message) {
                // message is Buffer
                addValue(Number(message))
                console.log(Number(message));
                //client.end()
            })
        
    </script>

</body>
</html>